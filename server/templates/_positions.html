{% if positions %}
  <table>
    <thead><tr><th>Side</th><th>Size</th><th>Entry</th><th>Mark</th><th>Liq</th><th>PNL</th><th>PNL%</th></tr></thead>
    <tbody>
      {% for sym, pos in positions.items() %}
        {# Keep templates light: prefer server-enriched fields #}
        {% set entry = pos.get('entry_price') is not none and (pos.get('entry_price')|float) or None %}
        {% set raw_size = pos.get('size') is not none and (pos.get('size')|float) or (pos.get('position_size') is not none and (pos.get('position_size')|float) or None) %}
        {% set mark = marks.get(sym) is not none and (marks.get(sym)|float) or None %}
        {% set liq = pos.get('liquidation_price') is not none and (pos.get('liquidation_price')|float) or None %}
        {% set pnl = pos.get('pnl_usd') is not none and (pos.get('pnl_usd')|float) or (pos.get('unrealized_pnl') is not none and (pos.get('unrealized_pnl')|float) or None) %}
        {% set pnl_pct = pos.get('pnl_pct') is not none and (pos.get('pnl_pct')|float) or None %}

        {% set side = pos.get('direction') or ('sell' if raw_size is not none and raw_size < 0 else 'buy') %}
      <tr>
        <td>{{ side }}</td>
        <td>{{ '%.0f'|format(raw_size) if raw_size is not none else '-' }}</td>
        <td>{{ entry is not none and ('%.2f'|format(entry)) or '-' }}</td>
        <td>{{ mark is not none and ('%.2f'|format(mark)) or '-' }}</td>
  <td>{{ liq is not none and ('%.2f'|format(liq)) or '-' }}</td>
  <td class="{{ 'pos' if pnl is not none and pnl>=0 else 'neg' }}">{{ pnl is not none and ('$' + ('%.2f'|format(pnl))) or '-' }}</td>
  <td class="{{ 'pos' if pnl_pct is not none and pnl_pct>=0 else 'neg' }}">{{ pnl_pct is not none and ('%.2f'|format(pnl_pct)) or '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="placeholder">No open positions</div>
{% endif %}
