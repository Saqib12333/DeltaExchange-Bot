{% if positions %}
  <table>
    <thead><tr><th>Side</th><th>Size</th><th>Entry</th><th>Mark</th><th>PNL</th></tr></thead>
    <tbody>
      {% for sym, pos in positions.items() %}
  {# Safely coerce numeric fields that may arrive as strings #}
  {% set _entry_raw = pos.entry_price if pos.entry_price is not none else pos.get('entry_price') %}
  {% set _size_raw = pos.size if pos.size is not none else pos.get('size') %}
  {% set _mark_raw = marks.get(sym) %}
  {% set entry = (_entry_raw|float) if _entry_raw is not none else None %}
  {% set raw_size = (_size_raw|float) if _size_raw is not none else None %}
  {% set mark = (_mark_raw|float) if _mark_raw is not none else None %}
      {# Infer side from explicit direction, otherwise from size sign #}
      {% set side = (pos.direction or pos.get('direction')) if (pos.direction or pos.get('direction')) else ('sell' if raw_size is not none and raw_size < 0 else 'buy') %}
      {# PnL formula: (mark - entry) * size works for both long(+) and short(-) #}
  {% set pnl = (mark - entry) * raw_size if (mark is not none and entry is not none and raw_size is not none) else None %}
      <tr>
        <td>{{ side }}</td>
        <td>{{ '%.0f'|format(raw_size) if raw_size is not none else '-' }}</td>
        <td>{{ entry is not none and ('%.2f'|format(entry)) or '-' }}</td>
        <td>{{ mark is not none and ('%.2f'|format(mark)) or '-' }}</td>
        <td class="{{ 'pos' if pnl is not none and pnl>=0 else 'neg' }}">{{ '%.2f'|format(pnl) if pnl is not none else '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="placeholder">No open positions</div>
{% endif %}
