{% if positions %}
  <table>
    <thead><tr><th>Symbol</th><th>Side</th><th>Size</th><th>Entry</th><th>Mark</th><th>PNL</th></tr></thead>
    <tbody>
      {% for sym, pos in positions.items() %}
      {% set entry = pos.entry_price or pos.get('entry_price') %}
      {% set raw_size = pos.size or pos.get('size') %}
      {% set mark = marks.get(sym) %}
      {# Infer side from explicit direction, otherwise from size sign #}
      {% set side = (pos.direction or pos.get('direction')) if (pos.direction or pos.get('direction')) else ('sell' if raw_size is not none and raw_size < 0 else 'buy') %}
      {# PnL formula: (mark - entry) * size works for both long(+) and short(-) #}
      {% set pnl = (mark - entry) * raw_size if (mark is not none and entry is not none and raw_size is not none) else None %}
      <tr>
        <td>{{ sym }}</td>
        <td>{{ side }}</td>
        <td>{{ '%.6f'|format(raw_size) if raw_size is not none else '-' }}</td>
        <td>{{ entry }}</td>
        <td>{{ mark or '-' }}</td>
        <td class="{{ 'pos' if pnl is not none and pnl>=0 else 'neg' }}">{{ '%.2f'|format(pnl) if pnl is not none else '-' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="placeholder">No open positions</div>
{% endif %}
